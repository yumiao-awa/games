<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>四线躲避</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #f5f7fa;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      color: #333;
    }
    h1 {
      font-size: 2em;
      margin-bottom: 10px;
      color: #4a6fa5;
    }
    #score, #high-score {
      font-size: 1.3em;
      margin: 8px 0;
      color: #e74c3c;
    }
    #game-area {
      position: relative;
      width: 400px;
      height: 500px;
      margin: 0 auto;
      background: #edf2f7;
      border: 2px solid #cbd5e0;
      border-radius: 10px;
      overflow: hidden;
    }
    .lane {
      position: absolute;
      width: 100px;
      height: 100%;
      top: 0;
      border-right: 1px dashed #a0aec0;
    }
    .lane:last-child {
      border-right: none;
    }
    #player {
      position: absolute;
      width: 80px;
      height: 20px;
      background: #3182ce;
      border-radius: 4px;
      bottom: 20px;
      left: 10px; /* 初始在第1条 */
      transition: left 0.15s ease;
    }
    .danger-line {
      position: absolute;
      width: 100px;
      height: 30px;
      background: #e53e3e;
      opacity: 0.85;
      border-radius: 4px 4px 0 0;
    }
    .controls {
      margin: 15px 0;
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .lane-btn {
      background: #a0aec0;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      color: white;
      font-weight: bold;
    }
    .lane-btn:hover {
      background: #718096;
    }
    #instructions {
      max-width: 400px;
      margin: 15px auto;
      font-size: 0.95em;
      color: #718096;
    }
    #game-over {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(245, 247, 250, 0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      font-size: 1.4em;
      color: #e53e3e;
    }
    #restart-btn {
      margin-top: 20px;
      padding: 10px 25px;
      background: #feb2b2;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>四线躲避</h1>
  <div id="score">得分: 0</div>
  <div id="high-score">最高分: 0</div>

  <div id="game-area">
    <div class="lane" style="left: 0;"></div>
    <div class="lane" style="left: 100px;"></div>
    <div class="lane" style="left: 200px;"></div>
    <div class="lane" style="left: 300px;"></div>
    <div id="player"></div>
    <div id="game-over">
      <div>游戏结束！</div>
      <div>得分: <span id="final-score">0</span></div>
      <button id="restart-btn">重新开始</button>
    </div>
  </div>

  <div class="controls">
    <button class="lane-btn" data-lane="0">1</button>
    <button class="lane-btn" data-lane="1">2</button>
    <button class="lane-btn" data-lane="2">3</button>
    <button class="lane-btn" data-lane="3">4</button>
  </div>

  <div id="instructions">
    每次只有一条轨道安全！<br>
    按 1/2/3/4 键 或 点击按钮切换轨道，避开红色危险线！
  </div>

  <script>
    const LANE_COUNT = 4;
    const LANE_WIDTH = 100;
    const PLAYER_WIDTH = 80;
    const DANGER_HEIGHT = 30;
    const GAME_HEIGHT = 500;
    const PLAYER_Y = GAME_HEIGHT - 20 - 20; // 底部20px空隙

    let playerLane = 0; // 0,1,2,3
    let dangers = [];
    let score = 0;
    let highScore = localStorage.getItem('dodgeHighScore') || 0;
    let gameRunning = true;
    let spawnRate = 1800; // 毫秒
    let lastSpawn = 0;

    const gameArea = document.getElementById('game-area');
    const player = document.getElementById('player');
    const scoreEl = document.getElementById('score');
    const highScoreEl = document.getElementById('high-score');

    highScoreEl.textContent = `最高分: ${highScore}`;

    function updatePlayerPosition() {
      player.style.left = `${playerLane * LANE_WIDTH + (LANE_WIDTH - PLAYER_WIDTH) / 2}px`;
    }

    function spawnDanger() {
      // 随机选择 1 条安全轨道（0-3）
      const safeLane = Math.floor(Math.random() * LANE_COUNT);
      // 其他 3 条为危险轨道
      const dangerLanes = [];
      for (let i = 0; i < LANE_COUNT; i++) {
        if (i !== safeLane) {
          dangerLanes.push(i);
        }
      }

      // 为每条危险轨道创建红线
      dangerLanes.forEach(lane => {
        const danger = document.createElement('div');
        danger.className = 'danger-line';
        danger.style.left = `${lane * LANE_WIDTH}px`;
        danger.style.top = '-30px';
        gameArea.appendChild(danger);

        dangers.push({
          el: danger,
          lane: lane,
          y: -30,
          speed: 4 + score * 0.01,
          safeLane: safeLane // 记录本次安全轨道（用于调试，实际不用）
        });
      });

      // 得分 +1（每组红线通过）
      score += 1;
      scoreEl.textContent = `得分: ${score}`;
      
      // 难度提升
      spawnRate = Math.max(800, 1800 - score * 20);
    }

    function updateDangers() {
      for (let i = dangers.length - 1; i >= 0; i--) {
        const danger = dangers[i];
        danger.y += danger.speed;
        danger.el.style.top = `${danger.y}px`;

        // 当红线到达玩家区域（底部）
        if (danger.y >= PLAYER_Y && danger.y <= PLAYER_Y + DANGER_HEIGHT) {
          // 检查玩家是否在这条危险轨道上
          if (playerLane === danger.lane) {
            gameOver();
            return;
          }
        }

        // 移除已通过的红线
        if (danger.y > GAME_HEIGHT) {
          danger.el.remove();
          dangers.splice(i, 1);
        }
      }
    }

    function gameOver() {
      gameRunning = false;
      document.getElementById('final-score').textContent = score;
      document.getElementById('game-over').style.display = 'flex';

      if (score > highScore) {
        highScore = score;
        localStorage.setItem('dodgeHighScore', highScore);
        highScoreEl.textContent = `最高分: ${highScore}`;
      }
    }

    function restart() {
      dangers.forEach(d => d.el.remove());
      dangers = [];
      score = 0;
      playerLane = 0;
      spawnRate = 1800;
      lastSpawn = 0;
      gameRunning = true;
      scoreEl.textContent = `得分: ${score}`;
      document.getElementById('game-over').style.display = 'none';
      updatePlayerPosition();
      location.reload();
    }

    function movePlayer(targetLane) {
      if (!gameRunning) return;
      playerLane = Math.max(0, Math.min(LANE_COUNT - 1, targetLane));
      updatePlayerPosition();
    }

    // 键盘控制：1/2/3/4
    window.addEventListener('keydown', (e) => {
      if (e.key >= '1' && e.key <= '4') {
        const lane = parseInt(e.key) - 1;
        movePlayer(lane);
      }
    });

    // 按钮控制
    document.querySelectorAll('.lane-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const lane = parseInt(btn.getAttribute('data-lane'));
        movePlayer(lane);
      });
    });

    document.getElementById('restart-btn').addEventListener('click', restart);

    function gameLoop(timestamp) {
      if (!gameRunning) return;

      // 生成新危险组
      if (timestamp - lastSpawn > spawnRate) {
        spawnDanger();
        lastSpawn = timestamp;
      }

      updateDangers();

      requestAnimationFrame(gameLoop);
    }

    updatePlayerPosition();
    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>